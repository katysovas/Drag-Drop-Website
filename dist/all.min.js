function onSignIn(e){if(!window.visitor.isRegistered){var t=e.getBasicProfile();t&&App.trigger("updateCookie",t)}}var BASE_URL="https://api.mongolab.com/api/1/databases/pagedb/collections",API_KEY="OtIKk5xORSRSn6BatrDeGAqNcfnMLW70",App=App||{},Models=Models||{};_.extend(App,Backbone.Events),$(document).ready(function(){new App.AppView}),function(e){var t={parse:function(e,t){return _.isObject(e._id)&&(e[this.idAttribute]=e._id.$oid,delete e._id),e},toExtendedJSON:function(){var e=this.attributes,e=_.omit(e,this.idAttribute);return _.isUndefined(this[this.idAttribute])||(e._id={$oid:this[this.idAttribute]}),e},sync:function(){var t=this.toJSON;this.toJSON=this.toExtendedJSON;var i=e.sync.apply(this,arguments);return this.toJSON=t,i}};e.MongoModel=e.Model.extend(t),e.MongoModel.mixin=t}.call(this,Backbone),function(){var e=Handlebars.template,t=Handlebars.templates=Handlebars.templates||{};t.editor=e({compiler:[7,">= 4.0.0"],main:function(e,t,i,a,n){var s;return'<div class="row page-nav-row">      \n	<div class="text-center page-tab-nav page-tab-nav-active">\n	'+e.escapeExpression((s=null!=(s=i.title||(null!=t?t.title:t))?s:i.helperMissing,"function"==typeof s?s.call(null!=t?t:{},{name:"title",hash:{},data:n}):s))+'\n	</div>\n</div>\n<div id="elements"></div>\n'},useData:!0}),t.sidebar=e({compiler:[7,">= 4.0.0"],main:function(e,t,i,a,n){var s;return'<input class="js-tab-title page-tab-fonts" placeholder="'+e.escapeExpression((s=null!=(s=i.title||(null!=t?t.title:t))?s:i.helperMissing,"function"==typeof s?s.call(null!=t?t:{},{name:"title",hash:{},data:n}):s))+'" maxlength="14" readonly/>\n<span class="page-tab-settings-icons js-tab-edit glyphicon glyphicon-pencil"></span>\n<span class="page-tab-settings-icons js-tab-delete glyphicon glyphicon-remove"></span>'},useData:!0})}(),Models.Page=Backbone.MongoModel.extend({urlRoot:BASE_URL+"/pages/",url:function(){var e=Backbone.Model.prototype.url.call(this),t=e+("/"==e.charAt(e.length-1)?"":"/");return t+="?apiKey="+API_KEY}}),Models.PageCollection=Backbone.Collection.extend({url:function(){return BASE_URL+"/pages/?apiKey="+API_KEY+'&q={"user_id":"'+this.userId+'"}'},model:Models.Page,initialize:function(e,t){this.userId=t.userId}}),Models.User=Backbone.MongoModel.extend({idAttribute:"_ID",defaults:{isRegistered:!1,name:"",email:""},urlRoot:BASE_URL+"/users/",url:function(){var e=Backbone.Model.prototype.url.call(this),t=e+("/"==e.charAt(e.length-1)?"":"/");return t+="?apiKey="+API_KEY},initialize:function(){window.visitor={isRegistered:this.defaults.isRegistered,name:this.defaults.name},this.readCookie()},readCookie:function(){$.cookie.json=!0;var e=$.cookie("Weebly");"undefined"!=typeof e&&e.isRegistered&&(this.defaults.name=e.name,this.defaults.isRegistered=!0,window.visitor=e)}}),Models.UserCollection=Backbone.Collection.extend({url:function(){return BASE_URL+"/users/?apiKey="+API_KEY+'&q={"user_id":"'+this.userId+'"}'},model:Models.User,initialize:function(e,t){this.userId=t.userId}}),function(e){"use strict";App.AppView=Backbone.View.extend({el:".wrapper",defaults:{autosave:4e4,enableLocaleStorage:!1},events:{"click .js-plus-sign":"createPage","keyup .js-page-tab-font-new":"createPageOnEnter"},initialize:function(){App.User=new Models.User({id:"560d69c5e4b0d5afa45748b1"}),App.bind("deleteItem",this.deletePage,this),App.bind("editor:show",this.showEditor,this),App.bind("saveDOM",this.saveDOM,this),App.bind("showLogin",this.showLogin,this),App.bind("updateCookie",this.updateCookie,this),this.tabList=this.$("#templatesList"),this.editor=this.$(".js-editor-canvas"),this.titleInput=this.$(".js-page-tab-font-new"),this.initComponents(),this.collection=new Models.PageCollection([],{userId:App.User.get("id")}),window.visitor.isRegistered&&this.fetchPages()},initComponents:function(){var t=this;e(".js-login").on("click",function(){return t.showLogin(),!1}),window.visitor.isRegistered&&e(".js-login").html("Hi, "+window.visitor.name);var i={appendTo:"body",helper:"clone"};this.$("#image-element").draggable(i),this.$("#text-element").draggable(i),this.$("#title-element").draggable(i),this.$("#nav-element").draggable(i)},showEditor:function(e){if(e){var t=new App.EditorView({model:e});this.editor.html(t.render().el)}else this.editor.html(" ")},deletePage:function(e){var t=this;e.destroy({success:function(){t.fetchPages()}}),App.trigger("editor:show")},fetchPages:function(){var e=this;e.defaults.enableLocaleStorage&&(e.collection.localStorage=new Backbone.LocalStorage("Weebly")),this.collection.fetch({success:function(){e.renderPages()}})},renderPages:function(){this.tabList.html(" "),this.collection.each(this.addPage,this)},addPage:function(e){var t=new App.PageView({model:e});this.tabList.append(t.render().el)},saveDOM:function(t,i){if(t.set("dom",i),t.save(),e(".js-autosave").addClass("active-save"),!this.defaults.enableLocaleStorage){setInterval(function(){console.log("auto saving"),t.save()},this.defaults.autosave)}},createPage:function(){var e=this;if(this.titleInput.val().length>0){var t=new Models.Page({title:this.titleInput.val()});t.set("user_id",App.User.get("id")),e.collection.add(t),t.save(null,{success:function(){e.fetchPages()}}),this.titleInput.val("")}return!1},createPageOnEnter:function(e){13==e.keyCode&&this.createPage()},showLogin:function(){return window.visitor.isRegistered||e("#myModal").modal(),!1},updateCookie:function(t){e.cookie.json=!0;var i={name:t.getName(),isRegistered:!0,id:"560d69c5e4b0d5afa45748b1",email:t.getEmail()};e.cookie("Weebly",i),window.location.reload()}})}(jQuery),App.EditorView=Backbone.View.extend({events:{"change textarea":"saveTextareaText","click .js-removeElement":"removeElement","change input":"saveTitleText","click .image-placeholder":"addImage","mouseover .js-removeElement":"addBorder","mouseout .js-removeElement":"removeBorder","keyup .title":"saveTitleOnEnter","focus .js-text-area":"expandTextArea","blur .nav":"makeURL"},saveTextareaText:function(e){var t=$(e.target);t.html(t.val()),App.trigger("saveDOM",this.model,this.elements.html())},saveTitleText:function(){var e=$(event.target);e.attr("value",e.val()),App.trigger("saveDOM",this.model,this.elements.html())},saveTitleOnEnter:function(e){13==e.keyCode&&(this.saveTitleText(),$(e.target).blur())},removeElement:function(e){$(e.target).parent().remove(),App.trigger("saveDOM",this.model,this.elements.html())},makeURL:function(e){var t=$(e.target).val(),i=$("<a>",{text:t,"class":"nav-url",title:t,href:"http://"+t,target:"_blank"});$(e.target).hide(),$(e.target).parent().append(i),App.trigger("saveDOM",this.model,this.elements.html())},addImage:function(e){var t=this,i=$(e.target).parent(),a=i.find("input");a.click(),a.change(function(e){for(var n=0;n<e.originalEvent.srcElement.files.length;n++){var s=e.originalEvent.srcElement.files[n],o=document.createElement("img"),l=new FileReader;l.onloadend=function(){o.src=l.result},l.readAsDataURL(s),i.find(".image-placeholder").remove(),a.remove(),i.find(".text-center").remove(),i.addClass("image-body-row-has-image"),i.find(".js-removeElement").after(o),setTimeout(function(){App.trigger("saveDOM",t.model,t.elements.html())},1e3)}})},addBorder:function(e){var t=$(e.target).parent();t.addClass("red-border")},removeBorder:function(e){var t=$(e.target).parent();t.removeClass("red-border")},expandTextArea:function(){$("#elements").on("keyup","textarea",function(e){$(this).css("height","auto"),$(this).height(this.scrollHeight)}),$("#elements").find("textarea").keyup()},render:function(){var e=this,t=Handlebars.templates.editor,i=t(this.model.toJSON());return this.$el.html(i),this.$el.css("height","100%"),this.elements=this.$("#elements"),this.model.has("dom")&&this.elements.html(this.model.get("dom")),this.expandTextArea(),this.elements.sortable({cancel:"textarea,input",placeholder:"sort-highlight",stop:function(){App.trigger("saveDOM",e.model,e.elements.html())}}),this.elements.droppable({drop:function(t,i){var a=i.draggable.attr("id");switch(a){case"title-element":var n=e.$(".title-row").length,s=e.model.get("id")+"_title_"+n,o="<div id="+s+' class="title-row"></span><span class="glyphicon glyphicon-remove js-removeElement" aria-hidden="true"></span><input class="title" style="border: none;" placeholder="Add Title Here"></div>';e.elements.append(o),$("#"+s).find("input").focus();break;case"text-element":var l=e.$(".text-row").length,s=e.model.get("id")+"_text_"+l,r="<div id="+s+' class="text-row"></span><span class="glyphicon glyphicon-remove js-removeElement" aria-hidden="true"></span><span class="elementCorner"></span><textarea class="js-text-area" placeholder="Enter text here."></textarea></div>';e.elements.append(r),e.expandTextArea(),$("#"+s).find("textarea").focus();break;case"image-element":var d=e.$(".image-body-row").length,s=e.model.get("id")+"_images_"+d,c="<div id="+s+' class="image-body-row"></span><span class="glyphicon glyphicon-remove js-removeElement" aria-hidden="true"></span><span class="elementCorner"></span><input id="image-upload-'+s+'" class="hidden js-uploadImage" type="file"><img class="image-placeholder" src="assets/images/placeholder.png"><div class="text-center"><p class="image-placeholder-text">ADD IMAGE</p><span class="plus-sign glyphicon glyphicon-plus image-plus "</span></div></div>';e.elements.append(c);break;case"nav-element":var p=e.$(".nav-row").length,s=e.model.get("id")+"_nav_"+p,h="<div id="+s+' class="nav-row"></span><span class="glyphicon glyphicon-remove js-removeElement" aria-hidden="true"></span><input class="nav" style="border: none;" placeholder="Add URL Here"></div>';e.elements.append(h),$("#"+s).find("input").focus()}App.trigger("saveDOM",e.model,e.elements.html())}}),this}}),App.PageView=Backbone.View.extend({className:"page-tab",events:{click:"activeTemplate","click .js-tab-delete":"removeItem","click .js-tab-edit":"editTabName","mouseenter .js-tab-delete":"addHoverWithDelay","mouseleave .js-tab-delete":"removeHoverWithDelay","keyup .js-tab-title":"saveTabNameonEnter"},initialize:function(){var e=this;$("#templatesList").children().removeClass("active"),this.$el.addClass("active"),App.trigger("editor:show",e.model)},activeTemplate:function(){this.$el.parent().children().removeClass("active"),this.$el.addClass("active"),App.trigger("editor:show",this.model)},removeItem:function(){App.trigger("deleteItem",this.model,this.$el.hasClass("active"))},addHoverWithDelay:function(e){window.timeoutId||(window.timeoutId=window.setTimeout(function(){window.timeoutId=null,$(e.target).parent().addClass("red-tab")},500))},removeHoverWithDelay:function(e){window.timeoutId?(window.clearTimeout(window.timeoutId),window.timeoutId=null):$(e.target).parent().removeClass("red-tab")},editTabName:function(){this.tabTitle=this.$(".js-tab-title"),this.tabTitle.prop("readOnly")?(this.tabTitle.focus(),this.tabTitle.prop("readonly",!1)):this.tabTitle.val().length>0&&(this.model.set("title",this.tabTitle.val()),this.model.save({title:this.tabTitle.val()}),this.tabTitle.prop("readonly",!0))},saveTabNameonEnter:function(e){13==e.keyCode&&(this.editTabName(),App.trigger("editor:show",this.model))},render:function(){var e=Handlebars.templates.sidebar,t=e(this.model.toJSON());return this.$el.html(t),this}});