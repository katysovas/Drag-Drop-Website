var BASE_URL="https://api.mongolab.com/api/1/databases/pagedb/collections",API_KEY="OtIKk5xORSRSn6BatrDeGAqNcfnMLW70",App=App||{},Models=Models||{};_.extend(App,Backbone.Events),$(document).ready(function(){new App.AppView}),function(e){var t={parse:function(e,t){return _.isObject(e._id)&&(e[this.idAttribute]=e._id.$oid,delete e._id),e},toExtendedJSON:function(){var e=this.attributes,e=_.omit(e,this.idAttribute);return _.isUndefined(this[this.idAttribute])||(e._id={$oid:this[this.idAttribute]}),e},sync:function(){var t=this.toJSON;this.toJSON=this.toExtendedJSON;var i=e.sync.apply(this,arguments);return this.toJSON=t,i}};e.MongoModel=e.Model.extend(t),e.MongoModel.mixin=t}.call(this,Backbone),function(){var e=Handlebars.template,t=Handlebars.templates=Handlebars.templates||{};t.editor=e({compiler:[7,">= 4.0.0"],main:function(e,t,i,a,s){var n;return'<div class="row page-nav-row">      \n	<div class="text-center page-tab-nav page-tab-nav-active">\n	'+e.escapeExpression((n=null!=(n=i.title||(null!=t?t.title:t))?n:i.helperMissing,"function"==typeof n?n.call(null!=t?t:{},{name:"title",hash:{},data:s}):n))+'\n	</div>\n</div>\n<div id="elements"></div>\n'},useData:!0}),t.sidebar=e({compiler:[7,">= 4.0.0"],main:function(e,t,i,a,s){var n;return'<input class="js-tab-title page-tab-fonts" placeholder="'+e.escapeExpression((n=null!=(n=i.title||(null!=t?t.title:t))?n:i.helperMissing,"function"==typeof n?n.call(null!=t?t:{},{name:"title",hash:{},data:s}):n))+'" maxlength="12" readonly/>\n<span class="page-tab-settings-icons js-tab-edit glyphicon glyphicon-pencil"></span>\n<span class="page-tab-settings-icons js-tab-delete glyphicon glyphicon-remove"></span>'},useData:!0})}(),Models.Page=Backbone.MongoModel.extend({urlRoot:BASE_URL+"/pages/",url:function(){var e=Backbone.Model.prototype.url.call(this),t=e+("/"==e.charAt(e.length-1)?"":"/");return t+="?apiKey="+API_KEY}}),Models.PageCollection=Backbone.Collection.extend({url:function(){return BASE_URL+"/pages/?apiKey="+API_KEY+'&q={"user_id":"'+this.userId+'"}'},model:Models.Page,initialize:function(e,t){this.userId=t.userId}}),Models.User=Backbone.MongoModel.extend({urlRoot:BASE_URL+"/users/",url:function(){var e=Backbone.Model.prototype.url.call(this),t=e+("/"==e.charAt(e.length-1)?"":"/");return t+="?apiKey="+API_KEY}}),Models.UserCollection=Backbone.Collection.extend({url:function(){return BASE_URL+"/users/?apiKey="+API_KEY+'&q={"user_id":"'+this.userId+'"}'},model:Models.User,initialize:function(e,t){this.userId=t.userId}}),function(e){"use strict";App.AppView=Backbone.View.extend({el:".wrapper",defaults:{autosave:3e4},events:{"click .js-plus-sign":"createPage","keyup .js-page-tab-font-new":"createPageOnEnter"},initialize:function(){App.User=new Models.User({id:"560d69c5e4b0d5afa45748b1"}),App.bind("deleteItem",this.deletePage,this),App.bind("editor:show",this.showEditor,this),App.bind("saveDOM",this.saveDOM,this),this.tabList=this.$("#templatesList"),this.$editor=this.$(".js-editor-canvas"),this.titleInput=this.$(".js-page-tab-font-new"),this.initComponents(),this.collection=new Models.PageCollection([],{userId:App.User.get("id")}),this.fetchPages()},initComponents:function(){var e={appendTo:"body",helper:"clone"};this.$("#image-element").draggable(e),this.$("#text-element").draggable(e),this.$("#title-element").draggable(e)},draggingTitle:function(e){},showEditor:function(e){if(e){var t=new App.EditorView({model:e});this.$editor.html(t.render().el)}else this.$editor.html(" ")},deletePage:function(e){var t=this;e.destroy({success:function(){t.fetchPages()}}),App.trigger("editor:show")},fetchPages:function(){var e=this;this.collection.fetch({success:function(){e.renderPages()}})},renderPages:function(){this.tabList.html(" "),this.collection.each(this.addPage,this)},addPage:function(e){var t=new App.PageView({model:e});this.tabList.append(t.render().el)},saveDOM:function(t,i){t.set("dom",i),t.save(),e(".js-autosave").addClass("active-save");setInterval(function(){console.log("auto saving"),t.save()},this.defaults.autosave)},createPage:function(){var e=this;if(this.titleInput.val().length>0){var t=new Models.Page({title:this.titleInput.val()});t.set("user_id",App.User.get("id")),t.save(null,{success:function(){e.fetchPages()}}),this.titleInput.val("")}return!1},createPageOnEnter:function(e){13==e.keyCode&&this.createPage()}})}(jQuery),App.EditorView=Backbone.View.extend({events:{"change textarea":"saveTextareaText","click .js-removeElement":"removeElement","change input":"saveTitleText","click .image-placeholder":"addImage","mouseover .js-removeElement":"addBorder","mouseout .js-removeElement":"removeBorder","keyup .title":"saveTitleOnEnter","focus .js-text-area":"expandTextArea"},saveTextareaText:function(e){var t=$(e.target);t.html(t.val()),App.trigger("saveDOM",this.model,this.elements.html())},saveTitleText:function(){var e=$(event.target);e.attr("value",e.val()),App.trigger("saveDOM",this.model,this.elements.html())},saveTitleOnEnter:function(e){13==e.keyCode&&(this.saveTitleText(),$(e.target).blur())},removeElement:function(e){$(e.target).parent().remove(),App.trigger("saveDOM",this.model,this.elements.html())},addImage:function(e){var t=this,i=$(e.target).parent(),a=i.find("input");a.click(),a.change(function(e){for(var s=0;s<e.originalEvent.srcElement.files.length;s++){var n=e.originalEvent.srcElement.files[s],l=document.createElement("img"),o=new FileReader;o.onloadend=function(){l.src=o.result},o.readAsDataURL(n),i.find(".image-placeholder").remove(),a.remove(),i.find(".text-center").remove(),i.addClass("image-body-row-has-image"),i.find(".js-removeElement").after(l),setTimeout(function(){App.trigger("saveDOM",t.model,t.elements.html())},1e3)}})},addBorder:function(e){var t=$(e.target).parent();t.addClass("red-border")},removeBorder:function(e){var t=$(e.target).parent();t.removeClass("red-border")},expandTextArea:function(){$("#elements").on("keyup","textarea",function(e){$(this).css("height","auto"),$(this).height(this.scrollHeight)}),$("#elements").find("textarea").keyup()},render:function(){var e=this,t=Handlebars.templates.editor,i=t(this.model.toJSON());return this.$el.html(i),this.$el.css("height","100%"),this.elements=this.$("#elements"),this.model.has("dom")&&this.elements.html(this.model.get("dom")),this.expandTextArea(),this.elements.sortable({cancel:"textarea,input",placeholder:"sort-highlight",stop:function(){App.trigger("saveDOM",e.model,e.elements.html())}}),this.elements.droppable({drop:function(t,i){var a=i.draggable.attr("id");switch(a){case"title-element":var s=e.$(".title-row").length,n=e.model.get("id")+"_title_"+s,l="<div id="+n+' class="title-row"></span><span class="glyphicon glyphicon-remove js-removeElement" aria-hidden="true"></span><input class="title" style="border: none;" placeholder="Add Title Here"></div>';e.elements.append(l),App.trigger("saveDOM",e.model,e.elements.html()),$("#"+n).find("input").focus();break;case"text-element":var o=e.$(".text-row").length,n=e.model.get("id")+"_text_"+o,r="<div id="+n+' class="text-row"></span><span class="glyphicon glyphicon-remove js-removeElement" aria-hidden="true"></span><span class="elementCorner"></span><textarea class="js-text-area" placeholder="Enter text here."></textarea></div>';e.elements.append(r),e.expandTextArea(),App.trigger("saveDOM",e.model,e.elements.html()),$("#"+n).find("textarea").focus();break;case"image-element":var d=e.$(".image-body-row").length,n=e.model.get("id")+"_images_"+d,c="<div id="+n+' class="image-body-row"></span><span class="glyphicon glyphicon-remove js-removeElement" aria-hidden="true"></span><span class="elementCorner"></span><input id="image-upload-'+n+'" class="hidden js-uploadImage" type="file"><img class="image-placeholder" src="assets/images/placeholder.png"><div class="text-center"><p class="image-placeholder-text">ADD IMAGE</p><span class="plus-sign glyphicon glyphicon-plus image-plus "</span></div></div>';e.elements.append(c),App.trigger("saveDOM",e.model,e.elements.html());break;case"nav-element":}}}),this}}),App.PageView=Backbone.View.extend({className:"page-tab",events:{click:"activeTemplate","click .js-tab-delete":"removeItem","click .js-tab-edit":"editTabName","mouseenter .js-tab-delete":"addHoverWithDelay","mouseleave .js-tab-delete":"removeHoverWithDelay","keyup .js-tab-title":"saveTabNameonEnter"},initialize:function(){var e=this;$("#templatesList").children().removeClass("active"),this.$el.addClass("active"),App.trigger("editor:show",e.model)},activeTemplate:function(){this.$el.parent().children().removeClass("active"),this.$el.addClass("active"),App.trigger("editor:show",this.model)},removeItem:function(){App.trigger("deleteItem",this.model,this.$el.hasClass("active"))},addHoverWithDelay:function(e){var t=$(e.target);window.timeoutId||(window.timeoutId=window.setTimeout(function(){window.timeoutId=null,t.parent().addClass("red-tab")},500))},removeHoverWithDelay:function(e){if(window.timeoutId)window.clearTimeout(window.timeoutId),window.timeoutId=null;else{var t=$(e.target);t.parent().removeClass("red-tab")}},editTabName:function(){this.tabTitle=this.$(".js-tab-title"),this.tabTitle.prop("readOnly")?(this.tabTitle.focus(),this.tabTitle.prop("readonly",!1)):this.tabTitle.val().length>0&&(this.model.set("title",this.tabTitle.val()),this.model.save({title:this.tabTitle.val()}),this.tabTitle.prop("readonly",!0))},saveTabNameonEnter:function(e){13==e.keyCode&&(this.editTabName(),App.trigger("editor:show",this.model))},render:function(){var e=Handlebars.templates.sidebar,t=e(this.model.toJSON());return this.$el.html(t),this}});